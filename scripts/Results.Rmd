---
title: "Untitled"
author: "Caitie"
date: "19/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(data.table)
library(countrycode)
library(raster)
library(sf)
```

# How many watersheds are transboundary globally?

```{r}
list_prop_basin<-list.files(here("output_data"), pattern = "Prop_basin_iso3", full.names = TRUE)

sub_prop_basin<-list_prop_basin[grep(list_prop_basin, pattern = ".csv")] 

dat <- 
  do.call(rbind,
          lapply(sub_prop_basin, read.csv))

```

```{r}
#Count number of countries in each watershed
iso3_basins<-dat %>% 
  group_by(MAIN_BAS) %>% 
  summarise(n_iso3 = length(unique(ISO3))) 
```

# Number of watersheds/countries

```{r}
# How many basins were assessed
length(unique(iso3_basins$MAIN_BAS))

# How many are transboundary
length(which(iso3_basins$n_iso3>1))

trans_basins<-iso3_basins %>% 
  filter(n_iso3 >1)

# Proportion of transboundary
length(which(iso3_basins$n_iso3>1))/length(unique(iso3_basins$MAIN_BAS))
```


```{r}
#Transboundary by continent
cont_basins<-dat %>% 
  group_by(Continent) %>% 
  summarise(n_basins = length(unique(MAIN_BAS)))

cont_trans_basins<-dat %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS) %>% 
  group_by(Continent) %>% 
  summarise(n_trans = length(unique(MAIN_BAS)))

cont<-full_join(cont_basins, cont_trans_basins) %>% 
  mutate(prop_trans = n_trans/n_basins)

cont
```



```{r}
iso3_cont_basins<-dat %>% 
  group_by(ISO3, Continent) %>% 
  summarise(n_basins = length(unique(MAIN_BAS)))

iso3_trans_basins<-dat %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS) %>% 
  group_by(ISO3, Continent) %>% 
  summarise(n_trans = length(unique(MAIN_BAS)))

iso3_df<-full_join(iso3_cont_basins, iso3_trans_basins) %>% 
  mutate(prop_trans = n_trans/n_basins,
         Country = countrycode(ISO3, "iso3c", "country.name"))
```

```{r}
# Number of countries in analysis
length(unique(iso3_df$ISO3))

# Number of countries with more than 1 basin
length(which(iso3_df$n_basins>1))

# Number of countries with transboundary basins
length(which(iso3_df$n_trans>0))

# Percent of countries with transboundary basin
length(which(iso3_df$n_trans>0))/length(unique(iso3_df$ISO3))
```

```{r}
#Number of countries where all basins are transboundary
length(which(iso3_df$prop_trans==1))

length(which(iso3_df$prop_trans==1))/length(unique(iso3_df$ISO3))
```

# Sediment export

```{r}
# Total sediment exported
#sed_moll<-raster(here("raw_data/Sediment/sediment_export_global_moll.tif"))

#total_sed<-cellStats(sed_moll, "sum")

total_sed<-24849341974

# unit is tonnes/ha/yr
#1 Mt = 1000000 t

#Estimated ha of global basins = 13511831300

total_sed_mt<-total_sed/1000000 #Megaton

total_sed_mt
```

# Sediment from all transboundary basins

```{r}
list_sed_basin<-list.files(here("output_data/Sediment"), pattern = ".shp", full.names = T)

#list_sed_basin<-list.files(here("output_data/Transboundary"), pattern = #"Terrestrial_transboundary_", full.names = TRUE)

sed_dat <- 
  do.call(rbind,
          lapply(list_sed_basin, st_read))

sub_dat<-dat %>% 
  dplyr::select(MAIN_BAS, n)

sed_dat2<-sed_dat %>% 
  as.data.frame() %>% 
  dplyr::select(-geometry) %>% 
  full_join(., sub_dat) %>% 
  filter(n>1)

trans_sed_sum<-sed_dat2 %>% 
  group_by(ISO3, Continent, MAIN_BAS) %>% 
  filter(!duplicated(sed_sum))

```

```{r}
# Total sediment export? What does this layer represent?
sum(trans_sed_sum$sed_sum, na.rm = T)/1000000 #Megaton

# Proportion of transboundary sed
sum(trans_sed_sum$sed_sum)/total_sed

# Number of basins
length(unique(sed_dat$MAIN_BAS))
```
# Transboundary mismatch

Mismatch in where the sediment comes form and where the pourpoint is

At this point we don't care whether it is cryptoheric or not

```{r}
list_mismatch<-list.files(here("output_data/Transboundary"), pattern = "Terrestrial", full.names = T)
  
mismatch<-do.call(rbind,
          lapply(list_mismatch, read.csv))

```

Mismatch between country that produces majority of sediment and where sediment is released
```{r}
sub_mismatch<-mismatch %>% 
  filter(max_sed_iso3 != pp_iso3,
          nchar(pp_iso3)==3)

length(unique(sub_mismatch$MAIN_BAS))
```

```{r}
sub_mismatch %>% 
  group_by(Continent) %>% 
  summarise(uniq_bas = length(unique(MAIN_BAS)),
            prop_bas = uniq_bas/length(unique(sub_mismatch$MAIN_BAS)))

table(sub_mismatch$Continent)/length(unique(sub_mismatch$MAIN_BAS))
```

Mismatches where >90% of sediment is produced in the country that does not contain the pourpoint

Potentially modify if we don't want rivers with no discharge.
```{r}
maj_sub_mismatch<-sub_mismatch %>% 
  filter(prop_sed>0.9)

length(unique(maj_sub_mismatch$MAIN_BAS))
```


```{r}
maj_sub_mismatch %>% 
  group_by(ISO3) %>% 
  summarise(uniq_bas = length(unique(MAIN_BAS)),
            prop_bas = uniq_bas/length(unique(maj_sub_mismatch$MAIN_BAS))) %>% 
  arrange(desc(prop_bas))
```


If we remove rivers without discharge it is

```{r}
sub_mismatch2<-sub_mismatch %>% 
  filter(rv_d_3_>0,
         !is.na(rv_d_3_) == T,
    max_sed_iso3 != pp_iso3)

length(unique(sub_mismatch2$MAIN_BAS))
```
Check these basins:
7080073410 Seems weird as multiple countries but they are small islands

Check ones that have charachter(0) as pp_loc

1080020200 in Africa but does not have Pp location - remove?
2080000360 Same as above in Asia
2080006710 Same as above
2080019300
2080022590
2080069200
4080002770


Additional areas of concern - but the same proportion of pourpoints across multiple countries
```{r}
equal_pp<-mismatch %>% 
  filter(nchar(pp_iso3)>3)
```


# Transboundary, cryptoheric watersheds

Pourpoint locations

```{r}
pp_loc_list<-list.files(here("output_data/Pourpoints"), pattern = "Missing_pp_chunk", full.names = T)

pp_loc_mis<-
  do.call(rbind,
          lapply(pp_loc_list, read.csv))

pp_all<-read.csv(here("output_data/Pourpoints/PP_location_all.csv"))

pp_done<-rbind(pp_all, pp_loc_mis) %>% 
  dplyr::select(HYRIV_I, NEXT_DO, MAIN_RI, rv_d_3_, ENDORHE, MAIN_BAS)
```

Join to sed dat

Number of cryptorheic basins
```{r}
crypt<-full_join(sed_dat, pp_done, by = "MAIN_BAS") %>% 
  filter(ENDORHE == 0)

length(unique(crypt$MAIN_BAS))/23934
```

Number of transboundary cryptoheric basins

```{r}
trans_crypt<-crypt %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS)

length(unique(trans_crypt$MAIN_BAS))
length(unique(trans_crypt$MAIN_BAS))/length(unique(trans_basins$MAIN_BAS))
```

Remove rivers with  no discharge - need to see what to do about these
```{r}
sub_trans_crypt<-crypt %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS,
         rv_d_3_>0)

length(unique(sub_trans_crypt$MAIN_BAS))
length(unique(sub_trans_crypt$MAIN_BAS))/length(unique(trans_basins$MAIN_BAS))
```
```{r}
trans_crypt_df<-trans_crypt %>% 
  as.data.frame() %>% 
  dplyr::select(-geometry)


trans_crypt_df %>% 
  group_by(Continent) %>% 
  summarise(uniq_bas = length(unique(MAIN_BAS)),
            prop_bas = uniq_bas/length(unique(trans_crypt$MAIN_BAS))) %>% 
  arrange(desc(prop_bas))
```
```{r}
trans_crypt_sed<-sed_dat %>% 
  filter(MAIN_BAS %in% trans_crypt$MAIN_BAS)

sum(trans_crypt_sed$sed_sum,na.rm = T)/1000000
sum(trans_crypt_sed$sed_sum,na.rm = T)/total_sed
```


# Transboundary coral reef sediments

DOUBLE CHECK THIS - make sure using right pourpoint layer

```{r}
# These pourpoints are just ones that drain to coral reefs? Double check
reef_pp<-st_read(here("raw_data/Pourpoints/pour_points_all.shp")) 

reef_sed<- trans_crypt_df %>% 
  filter(HYRIV_I %in% reef_pp$HYRIV_I)
```

```{r}
length(unique(reef_sed$MAIN_BAS))
length(unique(reef_sed$MAIN_BAS))/length(unique(trans_crypt_sed$MAIN_BAS))
```

```{r}
sum(reef_sed$sed_sum, na.rm = T)/sum(trans_crypt_sed$sed_sum, na.rm = T)

sum(reef_sed$sed_sum, na.rm = T)/sum(trans_sed_sum$sed_sum, na.rm = T)

sum(reef_sed$sed_sum, na.rm = T)/total_sed
```

