---
title: "Untitled"
author: "Caitie"
date: "19/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(data.table)
library(countrycode)
```

# How many watersheds are transboundary globally?

```{r}
list_prop_basin<-list.files(here("output_data"), pattern = "Prop_basin_iso3", full.names = TRUE)

sub_prop_basin<-list_prop_basin[grep(list_prop_basin, pattern = ".csv")] 

dat <- 
  do.call(rbind,
          lapply(sub_prop_basin, read.csv))

```

```{r}
#Count number of countries in each watershed
iso3_basins<-dat %>% 
  group_by(MAIN_BAS) %>% 
  summarise(n_iso3 = length(unique(ISO3))) 
```

# Number of watersheds/countries

```{r}
# How many basins were assessed
length(unique(iso3_basins$MAIN_BAS))

# How many are transboundary
length(which(iso3_basins$n_iso3>1))

trans_basins<-iso3_basins %>% 
  filter(n_iso3 >1)

# Proportion of transboundary
length(which(iso3_basins$n_iso3>1))/length(unique(iso3_basins$MAIN_BAS))
```


```{r}
#Transboundary by continent
cont_basins<-dat %>% 
  group_by(Continent) %>% 
  summarise(n_basins = length(unique(MAIN_BAS)))

cont_trans_basins<-dat %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS) %>% 
  group_by(Continent) %>% 
  summarise(n_trans = length(unique(MAIN_BAS)))

cont<-full_join(cont_basins, cont_trans_basins) %>% 
  mutate(prop_trans = n_trans/n_basins)

cont
```



```{r}
iso3_cont_basins<-dat %>% 
  group_by(ISO3, Continent) %>% 
  summarise(n_basins = length(unique(MAIN_BAS)))

iso3_trans_basins<-dat %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS) %>% 
  group_by(ISO3, Continent) %>% 
  summarise(n_trans = length(unique(MAIN_BAS)))

iso3_df<-full_join(iso3_cont_basins, iso3_trans_basins) %>% 
  mutate(prop_trans = n_trans/n_basins,
         Country = countrycode(ISO3, "iso3c", "country.name"))
```

```{r}
# Number of countries in analysis
length(unique(iso3_df$ISO3))

# Number of countries with more than 1 basin
length(which(iso3_df$n_basins>1))

# Number of countries with transboundary basins
length(which(iso3_df$n_trans>0))
```

# Sediment export

```{r}
# Total sediment exported
sed_moll<-raster(here("raw_data/Sediment/sediment_export_global_moll.tif"))

total_sed<-cellStats(sed_moll, "sum")

total_sed<-24849341974

# unit is tonnes/ha/yr
#1 Mt = 1000000 t

#Estimated ha of global basins = 13511831300

total_sed_mt<-total_sed/1000000 #Megaton
```


```{r}
list_sed_basin<-list.files(here("output_data/Transboundary"), pattern = "Terrestrial_transboundary_", full.names = TRUE)

sed_dat <- 
  do.call(rbind,
          lapply(list_sed_basin, read.csv))

```

```{r}
# Total sediment export, what units? What does this layer represent?
sum(sed_dat$sed_sum)

# Proportion of transboundary sed
sum(sed_dat$sed_sum)/total_sed
```

```{r}
sub_sed_dat<-sed_dat %>% 
  filter(pp_iso3 != max_sed_iso3)

test<-sub_sed_dat %>% 
  filter(pp_iso3 %in% c("c(\"IDN\", \"MYS\")", "c(\"IRN\", \"PAK\")","c(\"CRI\", \"NIC\")","c(\"PRI\", \"VIR\")"))

sub_sed_dat2<-sub_sed_dat %>% 
  filter(!pp_iso3 %in% c("c(\"IDN\", \"MYS\")", "c(\"IRN\", \"PAK\")","c(\"CRI\", \"NIC\")","c(\"PRI\", \"VIR\")"))

# Main basins with mismatch between country with max sediment export and country with pourpoint
length(unique(sub_sed_dat2$MAIN_BAS))

# Watersheds with equal proportion of pourpoints
length(unique(test$MAIN_BAS))
```

```{r}
# Basins where >90% of sediment is produced in a different country than the pourpoint
prop_sed<-sub_sed_dat2 %>% 
  filter(prop_sed>0.9)

length(unique(prop_sed$MAIN_BAS))
```

```{r}

length(which(sub_sed_dat2$n_iso3>1))
```

```{r}
test<-sub_sed_dat2 %>% 
  filter(!duplicated(MAIN_BAS))
```

```{r}
table(test$Continent)
```

