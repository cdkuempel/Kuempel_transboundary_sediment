---
title: "Untitled"
author: "Caitie"
date: "09/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggplot2)
library(tmap)
library(sf)
library(patchwork)
library(rnaturalearth)
library(rnaturalearthdata)
library(circlize)
#devtools::install_github("https://github.com/mattflor/chorddiag")
library(chorddiag)
library(randomcoloR)

t_crs<-'ESRI:54009'

```

# Terrestrial mismatch plot

Mismatch in where the sediment comes form and where the pourpoint is

At this point we don't care whether it is cryptoheric or not

```{r}
list_mismatch<-list.files(here("output_data/Transboundary"), pattern = "Terrestrial", full.names = T)
  
mismatch<-do.call(rbind,
          lapply(list_mismatch, read.csv))

```

Mismatch between country that produces majority of sediment and where sediment is released
```{r}
sub_mismatch<-mismatch %>% 
  filter(!pp_iso3 == "character(0)",
    max_sed_iso3 != pp_iso3,
          nchar(pp_iso3)==3,
    !prop_sed == 0)

length(unique(sub_mismatch$MAIN_BAS))
```

```{r}
africa<-sub_mismatch %>% 
  filter(Continent == "Africa",
         !ISO3 == pp_iso3,
         !is.na(pp_dis) == T) %>% 
  dplyr::select(ISO3, MAIN_BAS,pp_iso3, max_sed_iso3, pp_dis) %>% #pp_dis is pourpoint discharge from each country
  mutate(sed_mt = (pp_dis)/1000000) %>% 
  filter(sed_mt>0)

#length(unique(africa$MAIN_BAS))

asia<-sub_mismatch %>% 
  filter(Continent == "Asia",
         !ISO3 == pp_iso3,
         !is.na(pp_dis) == T) %>% 
  dplyr::select(ISO3, MAIN_BAS,pp_iso3, max_sed_iso3, pp_dis) %>% #pp_dis is pourpoint discharge from each country
  mutate(sed_mt = (pp_dis)/1000000) 

#length(unique(asia$MAIN_BAS))

europe<-sub_mismatch %>% 
  filter(Continent == "Europe",
         !ISO3 == pp_iso3,
         !is.na(pp_dis) == T) %>% 
  dplyr::select(ISO3, MAIN_BAS,pp_iso3, max_sed_iso3, pp_dis) %>% #pp_dis is pourpoint discharge from each country
  mutate(sed_mt = (pp_dis)/1000000)

#length(unique(europe$MAIN_BAS))

na<-sub_mismatch %>% 
  filter(Continent == "North America",
         !ISO3 == pp_iso3,
         !is.na(pp_dis) == T) %>% 
  dplyr::select(ISO3, MAIN_BAS,pp_iso3, max_sed_iso3, pp_dis) %>% #pp_dis is pourpoint discharge from each country
  mutate(sed_mt = (pp_dis)/1000000)

#length(unique(na$MAIN_BAS))

sa<-sub_mismatch %>% 
  filter(Continent == "South America",
         !ISO3 == pp_iso3,
         !is.na(pp_dis) == T) %>% 
  dplyr::select(ISO3, MAIN_BAS,pp_iso3, max_sed_iso3, pp_dis) %>% #pp_dis is pourpoint discharge from each country
  mutate(sed_mt = (pp_dis)/1000000)

#length(unique(sa$MAIN_BAS))
```



```{r}
africa_plot<-africa %>% 
 # dplyr::select(-max_sed_c) %>% 
  mutate(pp_c = countrycode(pp_iso3, "iso3c", "country.name"),
         country = countrycode(ISO3, "iso3c", "country.name")) %>% 
  group_by(country, pp_c) %>% 
  summarise(total_sed = sum(sed_mt, na.rm = T)) 

africa_plot<-africa_plot %>% 
  arrange(desc(total_sed)) %>% 
  filter(total_sed>70)
  


# Add in missing countries
cols<-unique(africa_plot$country)
rows<-unique(africa_plot$pp_c)

row_mis<-cols[!cols %in% rows]
col_mis<-rows[!rows %in% cols]

add_col<-data.frame(pp_c = NA, country = col_mis, total_sed = 0)
add_row<-data.frame(pp_c = row_mis, country = NA, total_sed = 0)

africa_plot2<-rbind(africa_plot, add_col) %>% 
  rbind(., add_row) %>% 
  pivot_wider(., names_from = "country", values_from = "total_sed") 

africa_plot2<-africa_plot2 %>% 
  dplyr::select(-"NA") %>% 
  filter(is.na(pp_c) == F)

africa_plot2[is.na(africa_plot2)] = 0

# Make sure col names and row names match up
africa_plot3<-africa_plot2 %>% 
  select(sort(colnames(africa_plot2)))
 # dplyr::select(max_sed_c,"Libya","Togo","Djibouti","Eritrea","Guinea","Tanzania", "Algeria","Western Sahara","Zimbabwe","Ghana","Benin","Ethiopia","Guinea-Bissau","Kenya","Liberia","Mauritania","Morocco","Mozambique", "Niger", "Sudan","Tunisia")

africa_char<-as.matrix(africa_plot3)

africa_mat<-data.matrix(africa_plot3)

rownames(africa_mat) <- africa_char[,"pp_c"]
africa_mat <- africa_mat[,-which(colnames(africa_mat) == "pp_c")] #remove pp_c column
```

```{r}
# A vector of 4 colors for 4 groups
source <- row.names(africa_mat)
sink<-colnames(africa_mat)

dimnames(africa_mat) <- list(source = source,
                    sink = sink)

n <- length(countries)
palette <- distinctColorPalette(n)
groupColors <- palette
```

```{r}
test<-africa %>% 
  filter(ISO3 == "DZA", 
         pp_iso3 == "LBY")
```


```{r}
p <- chorddiag(africa_mat, groupColors = groupColors, groupPadding = 5, groupnamePadding = 20, groupnameFontsize = 10)
p
```
```{r}
 library(htmlwidgets)
 saveWidget(p, file=here("figures/Terrestrial_trans_chord_interactive.html"))
```

```{r}
library(webshot)
saveWidget(x, "temp.html")
webshot("Terrestrial_trans_chord_interactive.html", "temp.png")
```

# Create plot

```{r}
# data
m <- matrix(c(11975,  5871, 8916, 2868,
              1951, 10048, 2060, 6171,
              8010, 16145, 8090, 8045,
              1013,   990,  940, 6907),
            byrow = TRUE,
            nrow = 4, ncol = 4)

```

```{r}
# A vector of 4 colors for 4 groups
haircolors <- c("black", "blonde", "brown", "red")
dimnames(m) <- list(have = haircolors,
                    prefer = haircolors)
groupColors <- c("#000000", "#FFDD89", "#957244", "#F26223")

# Build the chord diagram:
p <- chorddiag(m, groupColors = groupColors, groupnamePadding = 20)
p
```

