---
title: "Untitled"
author: "Caitie"
date: "23/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(here)
library(tidyverse)
library(ggplot2)
library(tmap)
library(sf)
library(patchwork)
library(rnaturalearth)
library(rnaturalearthdata)

t_crs<-'ESRI:54009'

```

# Load data

Number of countries per basin
```{r}
list_prop_basin<-list.files(here("output_data"), pattern = "Prop_basin_iso3", full.names = TRUE)

sub_prop_basin<-list_prop_basin[grep(list_prop_basin, pattern = ".csv")] 

dat <- 
  do.call(rbind,
          lapply(sub_prop_basin, read.csv))

```

Basin shapefile
```{r}
basins<-st_read(here("output_data/Basins/Basins_lv8_mainbasin_moll.shp")) %>% 
  st_make_valid()
```
```{r}
iso3_basins<-dat %>% 
  group_by(MAIN_BAS) %>% 
  summarise(n_iso3 = length(unique(ISO3))) 
```

# Country shapefile

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf") %>% 
  dplyr::select(iso_a3) %>% 
  rename(ISO3 = iso_a3) %>% 
  st_transform(., "+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +ellps=WGS84 +units=m +no_defs")
#class(world)
```
```{r}
#gadm_area<-st_read(here("output_data/GADM36/gadm36_dissolve_area.shp")) %>% 
#  st_make_valid() %>% 
#  st_transform(., "+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +ellps=WGS84 +units=m +no_defs")
  #st_transform(., "+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs")
```


# Figure 1


```{r}
shp_basins<-full_join(basins, iso3_basins) %>% 
  #st_transform("+proj=eck4 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs") %>% 
  st_transform(., "+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +ellps=WGS84 +units=m +no_defs")
```

```{r}
#breaks<-c(1,2,3,4,5, 6,7,8,9,12,14,19)
#breaks<-c(1,5,10,15,20)
breaks<-c(0,2,4,6,8,10,12,14,16,18,20)


#Needs to be categorical to have histogram

n_map<-tm_shape(shp_basins) +
    tm_fill("n_iso3", 
                breaks = breaks,
                style = "cont", 
                title = "                                Number of countries",
                palette = "-RdYlBu",
            legend.is.portrait = FALSE) +
  tm_borders(lwd = 0.2,
             alpha = 0.5)+
  #tm_legend(legend.position = c("bottom")) +
  tm_layout(legend.outside = T,
            legend.outside.position = "bottom",
            legend.position = c(0.1, 0.1),
            frame = F) +
  tm_shape(world) +
   tm_borders(alpha = 0.7) 
```

```{r}
n_map
```

```{r}
tmap_save(n_map, here("figures/Global_countries_per_basin.png"), dpi = 300)
```


# Continent bar charts

```{r}
iso3_cont_basins<-dat %>% 
  filter(!duplicated(MAIN_BAS)) %>% 
  group_by(Continent) %>% 
  summarise(n_basins = length(unique(MAIN_BAS)))


trans_basins<-dat %>% 
  filter(n >1)

iso3_trans_basins<-dat %>% 
  filter(MAIN_BAS %in% trans_basins$MAIN_BAS,
         !duplicated(MAIN_BAS)) %>% 
  group_by(Continent) %>% 
  summarise(n_trans = length(unique(MAIN_BAS)))

iso3_df<-full_join(iso3_cont_basins, iso3_trans_basins) %>% 
  mutate(prop_trans = n_trans/n_basins)
```

```{r}
list_crypt_sed_basin<-list.files(here("output_data/Transboundary"), pattern = "Terrestrial_transboundary_", full.names = TRUE)

crypt_sed_dat <- 
  do.call(rbind,
          lapply(list_crypt_sed_basin, read.csv))

trans_crypt_sed_sum<-crypt_sed_dat %>% 
  group_by(ISO3, Continent, MAIN_BAS) %>% 
  filter(!duplicated(MAIN_BAS))
```

```{r}
iso3_crypt_trans_basins<- trans_crypt_sed_sum %>% 
  filter(!duplicated(sed_sum)) %>% 
  group_by(Continent) %>% 
  summarise(n_crypt_basins = length(unique(MAIN_BAS)))

iso3_df<-full_join(iso3_cont_basins, iso3_trans_basins) %>%
  full_join(., iso3_crypt_trans_basins) %>% 
  mutate(n_single = n_basins - n_trans) %>% 
  dplyr::select(-n_basins) %>% 
  pivot_longer(., cols = c(n_single, n_trans, n_crypt_basins), names_to = "type", values_to = "n") %>% 
  mutate(labels = ifelse(type == "n_single","Single", 
                         ifelse(type == "n_trans", "Transboundary", "Trans-cryptorheic")))





#%>% 
#  mutate(prop_trans = n_trans/n_basins,
#         prop_crypt = n_crypt_basins/n_basins,
#         prop_trans_crypt = n_crypt_basins/n_trans)
```

```{r}
ggplot(iso3_df, aes(x = Continent, y = n, fill = factor(labels,levels=c("Single","Transboundary", "Trans-cryptorheic")))) +
  geom_bar(stat = "identity", position = "fill") +
  theme_minimal() +
  xlab("Continent") +
  ylab("Percent of basins") +
  labs(fill='Basin type') +
  scale_fill_manual(values = c("darkblue", "yellow", "darkred"))
```





